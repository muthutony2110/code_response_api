<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dark Chat UI with History Delete & Refresh</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Base dark theme */
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #181c2c;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #cce8ff;
      overflow: hidden;
    }
    #app-container {
      display: flex;
      height: 100vh;
      max-width: 1200px;
      margin: auto;
      background: #1a1f3a;
      border-radius: 10px;
      box-shadow: 0 0 25px #000a;
      overflow: hidden;
    }

    /* Left panel */
    #left-panel {
      flex: 0 0 320px;
      background: #232841;
      padding: 20px 20px 0 20px;
      display: flex;
      flex-direction: column;
    }

    /* Inputs */
    .inputs {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    .inputs label {
      font-weight: 600;
      font-size: 1rem;
      color: #83baff;
      user-select: text;
    }
    .inputs input {
      padding: 8px 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      background-color: #2d3657;
      color: #dbe9ff;
      outline: none;
      transition: background 0.3s ease;
    }
    .inputs input:focus {
      background-color: #3a4a7d;
    }

    /* Buttons vertical stack */
    #button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 0;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      box-shadow: 0 2px 10px #437fff7f;
      transition: background 0.25s ease;
      color: white;
      background-color: #3a76f0;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background-color: #4c8cff;
      box-shadow: 0 3px 14px #4c8cffaa;
    }
    button:disabled {
      background-color: #465e9f;
      cursor: not-allowed;
      box-shadow: none;
      color: #8ca3d9;
    }
    button.danger {
      background-color: #e64949;
      box-shadow: 0 2px 10px #e6494940;
    }
    button.danger:hover:not(:disabled) {
      background-color: #ff5555;
      box-shadow: 0 3px 14px #ff5555aa;
    }

    /* History list */
    #hlist {
      background: #232841;
      border-radius: 8px;
      border: 1.5px solid #2a3344;
      font-size: 1rem;
      color: #cce8ff;
      list-style: none;
      max-height: 340px;
      overflow-y: auto;
      padding: 0;
      user-select: none;
      box-sizing: border-box;
    }
    #hlist li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 13px 16px;
      border-bottom: 1px solid #28314b;
      cursor: pointer;
      transition: background 0.18s, color 0.13s;
    }
    #hlist li:last-child {
      border-bottom: none;
    }
    #hlist li:focus, #hlist li:hover {
      background: #337dff;
      color: #fff;
      outline: none;
    }
    .history-content {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-width: 260px;
      margin-right: 8px;
    }
    .hitem-prompt {
      font-weight: 600;
      color: #6fc7f1;
      font-size: 1rem;
      margin-bottom: 3px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .hitem-response {
      font-size: 0.97rem;
      color: #b2d7ff;
      opacity: 0.85;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .delete-history-btn {
      background: transparent;
      border: none;
      font-size: 1.3rem;
      color: #d75a5a;
      cursor: pointer;
      padding: 2px 6px;
      transition: color 0.3s ease;
      user-select: none;
    }
    .delete-history-btn:hover {
      color: #ff7f7f;
    }
    .delete-history-btn:focus {
      outline: none;
      color: #ff9494;
    }

    /* Right Panel - Chat */
    #right-panel {
      flex-grow: 1;
      background: #1e233f;
      display: flex;
      flex-direction: column;
      padding: 24px 30px 18px 30px;
      box-sizing: border-box;
    }

    /* Chat container */
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding-right: 12px;
      background: #2a2f55;
      border-radius: 10px;
      box-shadow: inset 0 0 15px rgb(0 0 0 / 0.7);
      font-size: 1rem;
      line-height: 1.5;
      color: #e0eaff;
      user-select: text;
      scroll-behavior: smooth;
      margin-bottom: 15px;
    }
    #chat-container::-webkit-scrollbar {
      width: 14px;
    }
    #chat-container::-webkit-scrollbar-thumb {
      background-color: #5589ff;
      border-radius: 8px;
      border: 3px solid #2a2f55;
    }
    #chat-container::-webkit-scrollbar-track {
      background-color: #1e233f;
      border-radius: 8px;
    }

    /* Chat message bubbles */
    .chat-msg {
      max-width: 80%;
      margin-bottom: 12px;
      padding: 14px 20px;
      border-radius: 20px;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    .chat-msg.user {
      background: linear-gradient(135deg, #3a76f0, #34c7ca);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 6px;
      font-weight: 600;
      box-shadow: 0 2px 12px #37a6faaa;
    }
    .chat-msg.bot {
      background: #334373;
      color: #c0cdfd;
      align-self: flex-start;
      border-bottom-left-radius: 6px;
      font-weight: 500;
      box-shadow: 0 2px 14px #2c3d7d82;
    }

    /* Code blocks within chat */
    pre.code-block {
      background: #1b2333;
      color: #90e1c1;
      font-family: 'JetBrains Mono', Consolas, monospace;
      font-size: 0.95rem;
      border-radius: 10px;
      padding: 18px;
      margin-top: 8px;
      max-height: 320px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1.5px solid #174c34;
      box-shadow: 0 0 8px #30d18950;
    }
    pre.code-block::-webkit-scrollbar {
      height: 12px;
    }
    pre.code-block::-webkit-scrollbar-thumb {
      background-color: #548eff;
      border-radius: 6px;
    }

    /* Input area styling */
    #input-area {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    #prompt-input {
      flex-grow: 1;
      border-radius: 8px;
      border: none;
      background-color: #2e3455;
      color: #e4ffe7;
      font-size: 1.05rem;
      padding: 11px 15px;
      min-height: 55px;
      max-height: 180px;
      resize: vertical;
      outline: none;
      font-family: inherit;
    }
    #prompt-input:focus {
      background-color: #363f6a;
    }
    #generate-button {
      background-color: #4a8aff;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 28px;
      height: 50px;
      box-shadow: 0 3px 15px #4a8aff77;
      transition: background-color 0.3s;
      user-select: none;
    }
    #generate-button:hover:enabled {
      background-color: #679aff;
      box-shadow: 0 4px 20px #679affaa;
    }
    #generate-button:disabled {
      background-color: #576f9a;
      cursor: not-allowed;
      box-shadow: none;
      color: #a3ade6;
    }

    /* Responsive */
    @media (max-width: 900px) {
      #app-container {
        flex-direction: column;
        height: 100vh;
        max-width: 100vw;
      }
      #left-panel {
        width: 100%;
        height: 15rem;
        padding: 12px 18px;
        border-right: none;
        border-bottom: 2px solid #2a2f4b;
      }
      #right-panel {
        flex-grow: 1;
        padding: 18px 20px 15px 20px;
        height: auto;
      }
      #chat-container {
        max-height: 270px;
        padding: 17px 20px 15px 20px;
      }
    }
  </style>
</head>
<body>
  <div id="app-container" role="main">
    <nav id="left-panel" aria-label="User inputs and conversation history">
      <section class="inputs" aria-label="User and Task input">
        <label for="userid-input">User ID
          <input id="userid-input" type="text" placeholder="User ID" autocomplete="off" />
        </label>
        <label for="taskname-input">Task Name
          <input id="taskname-input" type="text" placeholder="Task Name (optional)" autocomplete="off" />
        </label>
      </section>
      <section id="button-group" aria-label="Control buttons">
        <button id="fetch-history-btn" type="button" aria-describedby="fetch-desc">Fetch History</button>
        <span id="fetch-desc" class="sr-only">Fetch user or task history</span>
        <button id="delete-history-btn" type="button" class="danger" aria-describedby="delete-desc">Delete History</button>
        <span id="delete-desc" class="sr-only">Delete selected history</span>
        <button id="refresh-btn" type="button" aria-describedby="refresh-desc">Refresh</button>
        <span id="refresh-desc" class="sr-only">Refresh the current history display</span>
      </section>
      <ul id="hlist" role="list" tabindex="0" aria-label="Conversation history list"></ul>
    </nav>

    <section id="right-panel" aria-label="Chat conversation and prompt input">
      <div id="chat-container" tabindex="0" aria-live="polite" aria-atomic="false"></div>
      <section id="input-area">
        <textarea id="prompt-input" aria-label="Input prompt" placeholder="Type your prompt here..." rows="2"></textarea>
        <button id="generate-button" disabled>Generate</button>
      </section>
    </section>
  </div>

  <script>
    // Elements
    const userIdInput = document.getElementById('userid-input');
    const taskNameInput = document.getElementById('taskname-input');
    const fetchHistoryBtn = document.getElementById('fetch-history-btn');
    const deleteHistoryBtn = document.getElementById('delete-history-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const historyList = document.getElementById('hlist');
    const chatContainer = document.getElementById('chat-container');
    const promptInput = document.getElementById('prompt-input');
    const generateBtn = document.getElementById('generate-button');

    let chatMessages = [];
    let lastHistoryData = [];
    let lastUserId = null;
    let lastTaskName = null;
    let lastMode = "user"; // or "task"

    // Enable generate button only if userId, taskName and prompt input are non-empty
    function updateGenerateButtonState() {
      generateBtn.disabled = !(
        userIdInput.value.trim() &&
        taskNameInput.value.trim() &&
        promptInput.value.trim()
      );
    }
    userIdInput.addEventListener('input', updateGenerateButtonState);
    taskNameInput.addEventListener('input', updateGenerateButtonState);
    promptInput.addEventListener('input', updateGenerateButtonState);

    // Render chat messages to chatContainer
    function renderChat() {
      if (chatMessages.length === 0) {
        chatContainer.innerHTML = '<div style="color:#7daaff; text-align:center; margin-top:20vh; font-size:1rem;">Start your conversation...</div>';
        return;
      }
      chatContainer.innerHTML = '';
      chatMessages.forEach(({role, content, code}) => {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-msg ' + (role === 'user' ? 'user' : 'bot');
        msgDiv.textContent = content;
        chatContainer.appendChild(msgDiv);
        if (code) {
          const pre = document.createElement('pre');
          pre.className = 'code-block';
          pre.textContent = code;
          chatContainer.appendChild(pre);
        }
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Render history list with delete buttons
    function renderHistoryList(histories) {
      historyList.innerHTML = '';
      if (!histories.length) {
        const li = document.createElement('li');
        li.textContent = 'No history found.';
        li.style.color = '#7399c9';
        li.style.fontStyle = 'italic';
        historyList.appendChild(li);
        return;
      }
      histories.forEach((entry, idx) => {
        const li = document.createElement('li');
        li.tabIndex = 0;

        // Content div
        const contentDiv = document.createElement('div');
        contentDiv.className = 'history-content';
        contentDiv.title = `Prompt: ${entry.prompt}\nResponse: ${entry.message}`;

        const promptDiv = document.createElement('div');
        promptDiv.className = 'hitem-prompt';
        promptDiv.textContent = entry.prompt;
        contentDiv.appendChild(promptDiv);

        const responseDiv = document.createElement('div');
        responseDiv.className = 'hitem-response';
        responseDiv.textContent = entry.message;
        contentDiv.appendChild(responseDiv);
        li.appendChild(contentDiv);

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.className = 'delete-history-btn';
        delBtn.title = 'Delete this history entry';
        delBtn.type = 'button';
        delBtn.innerHTML = 'ðŸ—‘';

        delBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm('Are you sure you want to delete this history entry?')) return;

          try {
            const user_id = userIdInput.value.trim();
            const task_name = entry.task_name || taskNameInput.value.trim();
            const prompt_text = entry.prompt;
            if (!user_id || !task_name || !prompt_text) {
              alert('Cannot delete: Missing info.');
              return;
            }

            const params = new URLSearchParams({
              user_id,
              task_name,
              prompt: prompt_text
            });
            const res = await fetch(`/history/entry?${params.toString()}`, {
              method: 'DELETE'
            });
            if (!res.ok) throw new Error('Failed to delete entry.');
            const data = await res.json();
            alert(data.message || 'Entry deleted.');

            // Refresh history list after deletion
            await fetchHistory();
          } catch (err) {
            alert('Delete failed: ' + err.message);
          }
        });
        li.appendChild(delBtn);

        li.addEventListener('click', () => loadHistoryEntry(entry));
        li.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            loadHistoryEntry(entry);
          }
        });
        historyList.appendChild(li);
      });
    }

    // Load a selected history conversation into the chat area
    function loadHistoryEntry(entry) {
      chatMessages = [];
      if (entry.prompt) chatMessages.push({role: 'user', content: entry.prompt});
      let resp = entry.message || '';
      let code = entry.code || '';
      if (code && resp.includes(code)) {
        resp = resp.replace(code, '').trim();
      }
      if (resp || code) chatMessages.push({role: 'bot', content: resp, code});
      renderChat();
      promptInput.value = '';
      promptInput.focus();
    }

    // Fetch history from backend
    async function fetchHistory() {
      const userId = userIdInput.value.trim();
      const taskName = taskNameInput.value.trim();

      if (!userId) {
        alert('User ID is required to fetch history.');
        return;
      }
      let endpoint = '/history';
      let params = { user_id: userId };
      if (taskName) {
        endpoint = '/history/task';
        params.task_name = taskName;
      }

      try {
        const url = endpoint + '?' + new URLSearchParams(params);
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        const data = await response.json();
        if (!Array.isArray(data.history)) {
          alert('Unexpected data format received');
          return;
        }
        lastHistoryData = data.history;
        lastUserId = userId;
        lastTaskName = taskName || null;
        lastMode = taskName ? 'task' : 'user';
        renderHistoryList(lastHistoryData);
      }
      catch (err) {
        alert('Error fetching history: ' + err.message);
      }
    }

    // Delete history by user or task
    async function deleteHistory() {
      const userId = userIdInput.value.trim();
      const taskName = taskNameInput.value.trim();

      if (!userId) {
        alert('User ID is required to delete history.');
        return;
      }
      let endpoint = '/history';
      let params = { user_id: userId };
      if (taskName) {
        endpoint = '/history/task';
        params.task_name = taskName;
      }

      try {
        const url = endpoint + '?' + new URLSearchParams(params);
        const response = await fetch(url, { method: 'DELETE' });
        if (!response.ok) throw new Error(`Server error: ${response.status}`);
        const data = await response.json();
        lastHistoryData = [];
        renderHistoryList([]);
        chatMessages = [];
        renderChat();
        alert(data.message || 'History deleted');
      }
      catch(err) {
        alert('Error deleting history: ' + err.message);
      }
    }

    // Refresh whole page
    function refreshPage() {
      location.reload();
    }

    // Generate new chat completion
    async function generateResponse() {
      const userId = userIdInput.value.trim();
      const taskName = taskNameInput.value.trim();
      const promptText = promptInput.value.trim();
      if (!(userId && taskName && promptText)) {
        alert('Please fill User ID, Task Name, and prompt to generate');
        return;
      }
      chatMessages.push({ role: 'user', content: promptText });
      renderChat();
      promptInput.value = '';
      generateBtn.disabled = true;

      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: userId, task_name: taskName, prompt: promptText })
        });
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        const data = await res.json();
        if (data.response) {
          chatMessages.push({
            role: 'bot',
            content: data.response.message || '',
            code: data.response.code || ''
          });
        } else {
          alert('No response content');
        }
        renderChat();
        await fetchHistory();
      }
      catch (err) {
        alert('Generation failed: ' + err.message);
      }
      finally {
        generateBtn.disabled = false;
      }
    }

    // Button event handlers
    fetchHistoryBtn.addEventListener('click', fetchHistory);
    deleteHistoryBtn.addEventListener('click', deleteHistory);
    refreshBtn.addEventListener('click', refreshPage);
    generateBtn.addEventListener('click', generateResponse);

    // Enable generate button only with required inputs
    userIdInput.addEventListener('input', updateGenerateButtonState);
    taskNameInput.addEventListener('input', updateGenerateButtonState);
    promptInput.addEventListener('input', updateGenerateButtonState);

    // Enter sends prompt (Shift+Enter for newline)
    promptInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!generateBtn.disabled) generateBtn.click();
      }
    });

    // Initialize button states and focus
    window.onload = () => {
      renderChat();
      updateGenerateButtonState();
      userIdInput.focus();
    };
  </script>
</body>
</html>
